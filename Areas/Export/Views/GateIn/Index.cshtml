@model Dispatch_System.ResponseModel<Dispatch_System.GateIn>

@{
    ViewData["Title"] = "Gate In";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="content-header bg-gradient-green" style="border-radius: 0.25rem">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-12">
                <h1 class="font-weight-bold">Gate In</h1>
            </div>
        </div>
    </div>
</section>

<section class="content p-0">
    <div class="container-fluid p-0">
        <div class="row no-gutters">
            <div class="col-12 card">
                <form id="formSave" action="@Url.Action("Save", "GateIn", new { area = "Export" })" method="post" class="form-horizontal" enctype="multipart/form-data" data_form_isvalidate>
                    <div class="card-body pb-0">
                        <div class="panel-divider">
                            <span>Search Details</span>
                            <div class="row no-gutters p-0 m-0">
                                <div class="col-10 card card-primary p-0 m-0 shadow-none" style="margin: 0rem !important;">
                                    <div class="form-horizontal">
                                        <div class="card-body py-1 px-0">
                                            <div class="form-group row">
                                                <label class="col-sm-2 col-form-label"> MDA Number</label>
                                                <div class="col-4">
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" id="inputSearch" class="form-control form-control-sm">
                                                        <span class="input-group-append ml-2">
                                                            <button type="button" class="btn btn-info btn-flat mr-2" onclick="GetMDA(this, 'S')">Search</button>
                                                            <button type="button" class="btn btn-info btn-flat b-radius-0" onclick="GetMDA(this, 'V')" id="button_Common_View">View MDA</button>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-2">
                                                    <button type="button" class="btn btn-info btn-flat b-radius-0 ml-3" id="btnSyncMDA"
                                                            onclick="ajaxGet('@Url.Action("SyncMDA", "Home", new { area = "" })?FromDate=@DateTime.Now.AddDays(-1).ToString("dd/MM/yyyy").Replace("-","/")&ToDate=@DateTime.Now.ToString("dd/MM/yyyy").Replace("-","/")', false, '@Url.Action("Index", "GateIn", new { area = "Export" })')">
                                                        Sync MDA
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="Truck_No" class="col-sm-2 col-form-label">Vehicle Number <span class="text-danger">*</span></label>
                                                <div class="col-sm-4">
                                                    <input type="text" class="form-control form-control-sm truck_no" id="Truck_No" name="Truck_No" data-required data-msg="Vehicle Number is required." autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label for="Driver_Name" class="col-sm-4 col-form-label pl-0">Driver Name <span class="text-danger">*</span></label>
                                                        <span class="input-group-append col-sm-6 ml-0">
                                                            <input type="text" class="form-control form-control-sm truck_no" id="Driver_Name" name="Driver_Name" autocomplete="off" readonly>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label for="Driver_Contact" class="col-sm-4 col-form-label pl-0">Driver Contact <span class="text-danger">*</span></label>
                                                        <span class="input-group-append col-sm-6 ml-0">
                                                            <input type="text" class="form-control form-control-sm truck_no isNumberKey" id="Driver_Contact" name="Driver_Contact" autocomplete="off" readonly>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group row">
                                                <label for="Transporter_Name" class="col-sm-2 col-form-label">Transporter Name <span class="text-danger">*</span></label>
                                                <div class="col-sm-10">
                                                    <input type="text" class="form-control form-control-sm truck_no" id="Transporter_Name" name="Transporter_Name" autocomplete="off" readonly>
                                                    <input type="text" class="form-control form-control-sm d-none" id="Transporter_Code" name="Transporter_Code" autocomplete="off">
                                                </div>
                                            </div>

                                            <div class="form-group row">
                                                <label for="Transporter_Changed" class="col-sm-2 col-form-label">Is Transporter Changed ?</label>
                                                <div class="col-sm-10">
                                                    <div class="icheck-primary d-inline">
                                                        <input type="checkbox" id="Transporter_Changed" name="Transporter_Changed">
                                                        <label for="Transporter_Changed"> &nbsp; </label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group row diveAddTransporter d-none">
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label for="New_Transporter" class="col-sm-4 col-form-label pl-0">Select Transporter <span class="text-danger">*</span></label>
                                                        <div class="input-group-append col-sm-6 ml-0">
                                                            <select id="Transporter_Code_New" name="Transporter_Code_New" class="form-control form-control-sm select2" style="width: 100%;">
                                                                @if (Model != null && Model.SelectListItems.Where(x => x.Group == "TRANS") != null)
                                                                {
                                                                    foreach (var item in Model.SelectListItems.Where(x => x.Group == "TRANS"))
                                                                    {
                                                                        <option value="@item.Value" data-type="">@item.Text</option>
                                                                    }
                                                                }
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-2">
                                                    <button type="button" class="btn btn-info btn-flat b-radius-0 ml-3" onclick="btnClick_AddTransporter()">
                                                        + Add New Transporter
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel-divider">
                            <span id="span_common_no">MDA Details</span>
                            <div class="row no-gutters p-0 m-0">
                                <div class="col-10 card card-primary p-0 m-0 shadow-none" style="margin: 0rem !important;">
                                    <div class="form-horizontal">
                                        <div class="card-body py-1 px-0">
                                            <div class="form-group row">
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label class="col-sm-4 col-form-label pl-0" id="label_Common_No">MDA Number <span class="text-danger">*</span></label>
                                                        <span class="col-sm-6 ml-0">
                                                            <input type="text" class="form-control form-control-sm" id="input_Common_No" name="Common_No" readonly>
                                                            <input type="text" class="form-control form-control-sm d-none" id="input_Common_Id" name="Common_Sys_Id" readonly>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label class="col-sm-4 col-form-label pl-0" id="label_Common_Date">MDA Date <span class="text-danger">*</span></label>
                                                        <span class="col-sm-6 ml-0">
                                                            <input type="text" class="form-control form-control-sm" id="input_Common_Date" name="Common_Date" readonly>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group row">
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label class="col-sm-4 col-form-label pl-0">No of Bottles </label>
                                                        <span class="col-sm-6 ml-0">
                                                            <input type="text" class="form-control form-control-sm" id="input_Bag_Nos" readonly>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-6 d-none">
                                                    <div class="input-group input-group-sm ">
                                                        <label class="col-sm-4 col-form-label pl-0">No of Shippers </label>
                                                        <span class="col-sm-6 ml-0">
                                                            <input type="text" class="form-control form-control-sm" id="input_Shippers" readonly>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel-divider">
                            <span>Driver Details Validation</span>
                            <div class="row no-gutters p-0 m-0">
                                <div class="col-10 card card-primary p-0 m-0 shadow-none" style="margin: 0rem !important;">
                                    <div class="form-horizontal">
                                        <div class="card-body py-1 px-0">
                                            <div class="form-group row">
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label for="Driver_Id_Type" class="col-sm-4 col-form-label pl-0">Driver ID Proof Type</label>
                                                        <span class="input-group-append col-sm-6 ml-0">
                                                            <select id="Driver_Id_Type" name="Driver_Id_Type" class="form-control form-control-sm select2" style="width: 100%;">
                                                                @if (Model != null && Model.SelectListItems.Where(x => x.Group == "DRVIDPROOF") != null)
                                                                {
                                                                    foreach (var item in Model.SelectListItems.Where(x => x.Group == "DRVIDPROOF"))
                                                                    {
                                                                        <option value="@item.Value" data-type="">@item.Text</option>
                                                                    }
                                                                }

                                                            </select>

                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label for="Driver_Id_Number" class="col-sm-4 col-form-label pl-0">ID Proof Number</label>
                                                        <span class="input-group-append col-sm-6 ml-0">
                                                            <input type="text" class="form-control form-control-sm" id="Driver_Id_Number" name="Driver_Id_Number">
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="Driver_Changed" class="col-sm-2 col-form-label">Is Driver Details Changed ?</label>
                                                <div class="col-sm-10">
                                                    <div class="icheck-primary d-inline">
                                                        <input type="checkbox" id="Driver_Changed" name="Driver_Changed">
                                                        <label for="Driver_Changed"> &nbsp; </label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label for="New_Driver_Name" class="col-sm-4 col-form-label pl-0">New Driver Name</label>
                                                        <span class="input-group-append col-sm-6 ml-0">
                                                            <input type="text" class="form-control form-control-sm" id="New_Driver_Name" name="Driver_Name_New" readonly>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm ">
                                                        <label for="New_Driver_Contact" class="col-sm-4 col-form-label pl-0">New Driver Contact</label>
                                                        <span class="input-group-append col-sm-6 ml-0">
                                                            <input type="text" class="form-control form-control-sm isNumberKey" id="New_Driver_Contact" name="Driver_Contact_New" readonly>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel-divider">
                            <span>Vehicle Details Validation</span>
                            <div class="row no-gutters p-0 m-0">
                                <div class="col-10 card card-primary p-0 m-0 shadow-none" style="margin: 0rem !important;">
                                    <div class="form-horizontal">
                                        <div class="card-body py-1 px-0">
                                            <div class="form-group row">
                                                <div class="col-6">
                                                    <div class="form-group row">
                                                        <div class="col-12">
                                                            <div class="input-group input-group-sm py-1 px-0">
                                                                <label class="col-sm-4 col-form-label pl-0">Expected Bottle Qty <span class="text-danger">*</span></label>
                                                                <div class="col-sm-6 ml-0">
                                                                    <input type="text" class="form-control form-control-sm text-right isNumberKey" id="input_Expected_Qty" name="Expected_Shipper">
                                                                </div>
                                                            </div>

                                                            <div class="input-group input-group-sm py-1 px-0 d-none">
                                                                <label class="col-sm-4 col-form-label pl-0">Loaded Shipper Qty</label>
                                                                <div class="col-sm-6 ml-0">
                                                                    <input type="text" class="form-control form-control-sm text-right isNumberKey" id="input_Loaded_Qty" readonly>
                                                                </div>
                                                            </div>
                                                            <div class="input-group input-group-sm py-1 px-0">
                                                                <label class="col-sm-4 col-form-label pl-0">Is Vehicle Validated?</label>
                                                                <div class="col-sm-6 ml-0">
                                                                    <div class="icheck-primary d-inline">
                                                                        <input type="checkbox" id="Is_Truck_Validated" name="Truck_Validation">
                                                                        <label for="Is_Truck_Validated"> &nbsp; </label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-6" id="divLoaded_Qty">
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-divider mb-1">
                            <span>RFID Details</span>
                            <div class="row no-gutters p-0 m-0">
                                <div class="col-10 card card-primary p-0 m-0 shadow-none" style="margin: 0rem !important;">
                                    <div class="form-horizontal">
                                        <div class="card-body py-1 px-0">

                                            <div class="form-group row">
                                                <label for="RFID_Number" class="col-sm-2 col-form-label">RFID Number <span class="text-danger">*</span></label>
                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" id="RFID_Number" name="RFID_Number" class="form-control form-control-sm" autocomplete="off">
                                                        <span class="input-group-append ml-2">
                                                            <button type="button" onclick="getRfidNoCode('RfidNo')" class="btn btn-info btn-flat mr-2">Read RFID</button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group row">
                                                <label for="Is_RFID_Card_Read_Issue" class="col-sm-2 col-form-label">Is RFID Card Read Issue?</label>
                                                <div class="col-sm-10">
                                                    <div class="icheck-primary d-inline">
                                                        <input type="checkbox" id="Is_RFID_Card_Read_Issue" name="Rfid_Receive">
                                                        <label for="Is_RFID_Card_Read_Issue"> &nbsp; </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group row">
                                                <label for="RFID_Serial_Number" class="col-sm-2 col-form-label">RFID Serial Number <span class="text-danger">*</span></label>
                                                <div class="col-sm-4">
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" id="RFID_Serial_Number" name="RFID_Serial_Number" class="form-control form-control-sm">
                                                        <span class="input-group-append ml-2">
                                                            <button type="button" onclick="getRfidNoCode('RfidCode')" class="btn btn-info btn-flat mr-2">Validate</button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="button" class="btn btn-info btn-flat px-3 mr-3 btnSubmit">Save</button>
                        <button type="button" class="btn btn-danger btn-flat px-3 mr-3">Close</button>
                        <span class="float-right mr-3"><span class="text-danger">*</span> Mandatory Fields</span>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script type="text/javascript">
        var table = {};

        $(document).ready(function () {

        });

        function fnShow_Modal_Success($url, $title) {


        }

        function fnChange_Select($this, $selecter) {

            if (typeof $selecter != 'undefined' && $selecter != null && $selecter != '' && $selecter.length > 0) {

                var selectedValue = $($this).find('option:selected').val();

                if (typeof selectedValue != 'undefined' && selectedValue != null && selectedValue != '' && selectedValue.length > 0)
                    $($selecter).val(selectedValue);
                else
                    $($selecter).val('');

                $($selecter).trigger('change');
            }
            else {
                if ($this != null)
                    fnClear_MDA();

            }
        }

        function GetMDA($this, $type) {
            ShowLoader(true);

            if (typeof $type != 'undefined' && $type != null && $type != "null" && $type.trim() != 'S') $('#inputSearch').val('').trigger('change');
            //	fnClear_MDA();

            if ($('#modal-xl').hasClass('show')) $('#modal-xl').hide();

            $.ajax({
                type: "GET",
                url: '@Url.Action("GetMDA", "GateIn", new { area = "Export" })?type=' + $type + '&searchTerm=' + $('#inputSearch').val(),
                data: null,
                contentType: "application/json; charset=utf-8",
                dataType: "html",
                success: function (response) {

                    fnClear_MDA();

                    if (typeof response == 'undefined' || response == null || response == 'null' || response.length <= 0) {
                        CommonAlert_Error("No any record(s) found");
                        return false;
                    }

                    if (response.indexOf('{') == 0) {

                        setTimeout(function () {

                            try {

                                if (typeof response != 'undefined' && response != null && response.length > 0) {

                                    var selectedData = JSON.parse(response);

                                    $('#Truck_No').val(selectedData['vehicle_no']);
                                    $('#input_Common_Id').val(selectedData['id']);
                                    $('#input_Common_No').val(selectedData['mda_no']);
                                    $('#input_Common_Date').val(selectedData['mda_dt']);
                                    $('#Transporter_Code').val(selectedData['tptr_cd']);
                                    $('#Transporter_Name').val(selectedData['tptr_name']);
                                    $('#Driver_Name').val(selectedData['driver']);
                                    $('#Driver_Contact').val(selectedData['mobile_no']);
                                    $('#input_Bag_Nos').val(selectedData['bag_nos']);
                                    $('#input_Shippers').val(selectedData['required_Shipper']);

                                    var Required_Shipper = selectedData['required_Shipper'];

                                    if (typeof Required_Shipper == 'undefined' || Required_Shipper == null || Required_Shipper == '' || isNaN(parseFloat(Required_Shipper))) { Required_Shipper = 0; }
                                    else { Required_Shipper = parseFloat(Required_Shipper); }

                                    var Loaded_Shipper = selectedData['expected_Shipper'];

                                    if (typeof Loaded_Shipper == 'undefined' || Loaded_Shipper == null || Loaded_Shipper == '' || isNaN(parseFloat(Loaded_Shipper))) { Loaded_Shipper = 0; }
                                    else { Loaded_Shipper = parseFloat(Loaded_Shipper); }

                                    $('#input_Expected_Qty').val((Required_Shipper - Loaded_Shipper));
                                    $('#input_Loaded_Qty').val(Loaded_Shipper);

                                    

                                    var Vehicle_Shippers = selectedData['vehicle_Shippers'];

                                    if (typeof Vehicle_Shippers != 'undefined' && Vehicle_Shippers != null && Vehicle_Shippers != '') {
                                        var records = Vehicle_Shippers.split(',');
                                        var parsedArray = [];

                                        records.forEach(function (record) {

                                            var parts = record.split('|');

                                            var recordObject = {
                                                GATE_SYS_ID: (parts.length >= 1) ? parts[0] : 0,
                                                VEHICLE_NO: (parts.length >= 2) ? parts[1] : '',
                                                Expected_Shipper: (parts.length >= 3) ? parts[2] : 0,
                                                Loaded_Shipper: (parts.length >= 4) ? parts[3] : 0,
                                                Status: (parts.length >= 5) ? parts[4] : ''
                                            };

                                            parsedArray.push(recordObject);
                                        });

                                        

                                        if (typeof parsedArray != 'undefined' && parsedArray != null && parsedArray.length > 0) {

                                            var html = '<table class="table table-sm"><thead> <tr> <th style="width: 3%" class="text-center">#</th> <th class="text-center">Vehicle No.</th> <th class="text-center">Progress</th> <th class="text-center">Expected Qty</th> <th class="text-center">Loaded Qty</th> </tr></thead>'
                                                + '<tbody> ';

                                            parsedArray.forEach(function (record, index) {
                                                html += '<tr> <td style="width: 3%" class="text-center">' + (index + 1) + '</td> <td class="text-center">' + record.VEHICLE_NO + '</td> <td class="text-center">' + record.Status + '</td> <td class="text-center">' + record.Expected_Shipper + '</td> <td class="text-center">' + record.Loaded_Shipper + '</td> </tr> ';
                                            });

                                            html += '</tbody> </table>';

                                            $('#divLoaded_Qty').html(html);
                                        }

                                    }

                                    $('#Truck_No').trigger('change');
                                    $('#input_Common_Id').trigger('change');
                                    $('#input_Common_No').trigger('change');
                                    $('#input_Common_Date').trigger('change');
                                    $('#Transporter_Code').trigger('change');
                                    $('#Transporter_Name').trigger('change');
                                    $('#Driver_Name').trigger('change');
                                    $('#Driver_Contact').trigger('change');
                                    $('#input_Expected_Qty').trigger('change');
                                    $('#input_Loaded_Qty').trigger('change');
                                    $('#input_Bag_Nos').trigger('change');
                                    $('#input_Shippers').trigger('change');

                                } else
                                    CommonAlert_Error("No record found");

                            } catch { }

                            ShowLoader(false);

                        }, 1000);

                    }
                    else {

                        $('#modal-xl .modal-body').html('');
                        $('#modal-xl .modal-body').append(response);

                        if ($type == 'S')
                            $('#modal-xl .modal-title').html('Search MDA');
                        else
                            $('#modal-xl .modal-title').html('View MDA');


                        setTimeout(function () {

                            try {

                                if ($.fn.DataTable.isDataTable('#modal-xl .modal-body #table_Common')) {
                                    $('#modal-xl .modal-body #table_Common').DataTable().destroy();
                                }

                                table = $('#modal-xl .modal-body #table_Common').DataTable({
                                    paging: true,
                                    lengthChange: true,
                                    searching: true,
                                    ordering: true,
                                    info: true,
                                    autoWidth: true,
                                    responsive: true,
                                    order: [[0, 'asc']],
                                    pageLength: 10,
                                    lengthMenu: [
                                        [10, 25, 50, -1],
                                        [10, 25, 50, 'All']
                                    ],
                                    //columnDefs: [
                                    //	{ "targets": 0, "className": "text-center", "width": "3%", "autoWidth": false, "searchable": false, "orderable": false },
                                    //	{ "targets": -1, "className": "text-center", "width": "3%", "autoWidth": false, "searchable": false, "orderable": false }
                                    //],
                                    fixedColumns: true,
                                    dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                                        "<'row'<'col-sm-12'tr>>" +
                                        "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>"
                                    // , drawCallback: function () {
                                    //
                                    // 	$('.paginate_button.next:not(.disabled)', this.api().table().container())
                                    // 		.on('click', function () {
                                    // 			alert('next');
                                    // 		});
                                    // }
                                });

                                $('#modal-xl .modal-body #table_Common').css('width', '100%');

                                table.on('click', 'tbody tr', function (e) {

                                    fnClear_MDA();

                                    $(e.currentTarget.parentElement).find('tr').each(function (i, ez) {
                                        if (i != (e.currentTarget.rowIndex - 1))
                                            $(ez).removeClass('bg-info');
                                    });

                                    e.currentTarget.classList.toggle('bg-info');

                                });


                            } catch { }

                            if ($('#modal-xl .modal-body #table_Common tbody tr').length > 0)
                                $('#modal-xl').show(); //$('#modal-xl').modal('show');
                            else
                                CommonAlert_Error("No any record(s) found");

                            ShowLoader(false);

                        }, 1000);
                    }
                },
                failure: function (response) { fnClear_MDA(); CommonAlert_Error(null); },
                error: function (response) { fnClear_MDA(); CommonAlert_Error(null); }
            });
        }

        function fnSelect_MDA() {

            if ($('#table_Common tbody tr.bg-info').length <= 0) {
                CommonAlert_Error("Please select MDA(s).");
                return false;
            }
            else {



                var data = table.rows('.bg-info').data().toArray();

                const numberOfColumns = data[0].length;

                const selectedData = [];


                for (let i = 0; i < numberOfColumns; i++) {

                    const columnValues = data.map(row => row[i]);

                    const uniqueArr = columnValues.filter((element, index) => {
                        return columnValues.indexOf(element) === index;
                    });

                    selectedData.push(uniqueArr.join(', '));
                }



                $('#Truck_No').val(selectedData[2]);
                $('#input_Common_No').val(selectedData[3]);
                $('#input_Common_Id').val(selectedData[1]);
                $('#input_Common_Date').val(selectedData[6]);
                //$('#Transporter_Code').val(selectedData[5]);
                $('#Transporter_Name').val(selectedData[7]);

                if (selectedData[9].indexOf(',') > -1)
                    $('#Driver_Name').val(selectedData[9].substring(0, selectedData[9].indexOf(',')));
                else
                    $('#Driver_Name').val(selectedData[9]);

                if (selectedData[10].indexOf(',') > -1)
                    $('#Driver_Contact').val(selectedData[10].substring(0, selectedData[10].indexOf(',')));
                else
                    $('#Driver_Contact').val(selectedData[10]);

                $('#input_Bag_Nos').val(selectedData[15]);
                $('#input_Shippers').val(selectedData[11]);

                var Required_Shipper = selectedData[11];

                if (typeof Required_Shipper == 'undefined' || Required_Shipper == null || Required_Shipper == '' || isNaN(parseFloat(Required_Shipper))) { Required_Shipper = 0; }
                else { Required_Shipper = parseFloat(Required_Shipper); }

                var Loaded_Shipper = selectedData[13];

                if (typeof Loaded_Shipper == 'undefined' || Loaded_Shipper == null || Loaded_Shipper == '' || isNaN(parseFloat(Loaded_Shipper))) { Loaded_Shipper = 0; }
                else { Loaded_Shipper = parseFloat(Loaded_Shipper); }

                $('#input_Expected_Qty').val((Required_Shipper - Loaded_Shipper));
                $('#input_Loaded_Qty').val(Loaded_Shipper);

                

                var Vehicle_Shippers = selectedData[14];

                if (typeof Vehicle_Shippers != 'undefined' && Vehicle_Shippers != null && Vehicle_Shippers != '') {
                    var records = Vehicle_Shippers.split(',');
                    var parsedArray = [];

                    records.forEach(function (record) {

                        var parts = record.split('|');

                        var recordObject = {
                            GATE_SYS_ID: (parts.length >= 1) ? parts[0] : 0,
                            VEHICLE_NO: (parts.length >= 2) ? parts[1] : '',
                            Expected_Shipper: (parts.length >= 3) ? parts[2] : 0,
                            Loaded_Shipper: (parts.length >= 4) ? parts[3] : 0,
                            Status: (parts.length >= 5) ? parts[4] : ''
                        };

                        parsedArray.push(recordObject);
                    });

                    

                    if (typeof parsedArray != 'undefined' && parsedArray != null && parsedArray.length > 0) {

                        var html = '<table class="table table-sm"><thead> <tr> <th style="width: 3%" class="text-center">#</th> <th class="text-center">Vehicle No.</th> <th class="text-center">Progress</th> <th class="text-center">Expected Qty</th> <th class="text-center">Loaded Qty</th> </tr></thead>'
                            + '<tbody> ';

                        parsedArray.forEach(function (record, index) {
                            html += '<tr> <td style="width: 3%" class="text-center">' + (index + 1) + '</td> <td class="text-center">' + record.VEHICLE_NO + '</td> <td class="text-center">' + record.Status + '</td> <td class="text-center">' + record.Expected_Shipper + '</td> <td class="text-center">' + record.Loaded_Shipper + '</td> </tr> ';
                        });

                        html += '</tbody> </table>';

                        $('#divLoaded_Qty').html(html);
                    }

                }

                $('#Truck_No').trigger('change');
                $('#input_Common_No').trigger('change');
                $('#input_Common_Id').trigger('change');
                $('#input_Common_Date').trigger('change');
                $('#Transporter_Code').trigger('change');
                $('#Transporter_Name').trigger('change');
                $('#Driver_Name').trigger('change');
                $('#Driver_Contact').trigger('change');
                $('#input_Expected_Qty').trigger('change');
                $('#input_Loaded_Qty').trigger('change');
                $('#input_Bag_Nos').trigger('change');
                $('#input_Shippers').trigger('change');

                fnClose_Modal();
            }
        }

        function fnClear_MDA() {

            //$('#table_Common tbody tr.bg-info').each(function (i, ez) {
            //	$(ez).removeClass('bg-info');
            //});

            try { table.rows().nodes().to$().removeClass('bg-info'); } catch { }

            //fnChange_Select(null);

            $('#Truck_No').val('');
            $('#input_Common_No').val('');
            $('#input_Common_Name').val('');
            $('#input_Common_Code').val('');
            $('#input_Common_Id').val('');
            $('#input_Common_Date').val('');
            $('#Transporter_Code').val('');
            $('#Transporter_Name').val('');
            $($('#Transporter_Name').parents('div.row')[0]).removeClass('d-none')
            $('#Driver_Name').val('');
            $('#Driver_Contact').val('');

            $('#divLoaded_Qty').html('');
            $('#input_Expected_Qty').val('').trigger('change');
            $('#input_Loaded_Qty').val('').trigger('change');
            $('#input_Bag_Nos').val('').trigger('change');
            $('#input_Shippers').val('').trigger('change');

            $('#Truck_No').trigger('change');
            $('#input_Common_No').trigger('change');
            $('#input_Common_Name').trigger('change');
            $('#input_Common_Code').trigger('change');
            $('#input_Common_Id').trigger('change');
            $('#input_Common_Date').trigger('change');
            $('#Transporter_Code').trigger('change');
            $('#Transporter_Name').trigger('change');
            $('#Driver_Name').trigger('change');
            $('#Driver_Contact').trigger('change');

            //$('#Truck_No').prop('readonly', true);
            $('#Driver_Name').prop('readonly', true);
            $('#Driver_Contact').prop('readonly', true);

            $('#RFID_Number').val('');
            $('#RFID_Serial_Number').val('');
            $('#Is_RFID_Card_Read_Issue').prop('checked', false);

            $('#RFID_Number').trigger('change');
            $('#RFID_Serial_Number').trigger('change');
            $('#Is_RFID_Card_Read_Issue').trigger('change');

            $('#Driver_Id_Type').val('');
            $('#Driver_Id_Type').trigger('change');

            $('#Driver_Changed').prop('checked', false);
            $('#Driver_Changed').trigger('change');

            $('#Transporter_Changed').prop('checked', false);
            $('#Transporter_Changed').trigger('change');

            $('input#Transporter_Code_New').val('');
            $('input#Transporter_Code_New').trigger('change');

            if (!$(".diveAddTransporter").hasClass("d-none")) { $(".diveAddTransporter").addClass("d-none"); }

            $('#Is_Truck_Validated').prop('checked', false);
            $('#Is_Truck_Validated').trigger('change');

        }

        $(document).on("change", 'input#Driver_Changed', function (e) {

            $('input#New_Driver_Name').val('')
            $('input#New_Driver_Name').trigger('change')

            $('input#New_Driver_Contact').val('')
            $('input#New_Driver_Contact').trigger('change')

            $('input#New_Driver_Name').prop('readonly', !e.target.checked);
            $('input#New_Driver_Contact').prop('readonly', !e.target.checked);
        });

        function getRfidNoCode(btn) {
            ShowLoader(true);

            if (btn == 'RfidNo') {
                $('#RFID_Serial_Number').val('');
            } else {
                $('#RFID_Number').val('');
            }

            $.ajax({
                type: "GET",
                url: '@Url.Action("fnGetRfidNoCode", "GateIn", new { area = "Dispatch" })?rfidNo=' + $('#RFID_Serial_Number').val() + '&rfidCode=' + $('#RFID_Number').val(),
                data: null,
                contentType: "application/json; charset=utf-8",
                dataType: "html",
                success: function (response) {

                    if (typeof response == 'undefined' || response == null || response == 'null' || response.length <= 0) {
                        CommonAlert_Error("No any record(s) found");
                        return false;
                    }

                    if (response.indexOf('{') == 0) {

                        setTimeout(function () {

                            try {

                                if (typeof response != 'undefined' && response != null && response.length > 0) {

                                    var selectedData = JSON.parse(response);

                                    if (selectedData['status'] != "Active") {
                                        CommonAlert_Error(selectedData['reasonforEdit']);
                                        return false;
                                    }

                                    $('#RFID_Number').val(selectedData['rfidCode']);
                                    $('#RFID_Serial_Number').val(selectedData['rfidSrno']);
                                    //$('#Remarks').html(selectedData['remarks']);
                                    //$('#Allow_Out_Tolerance').html(selectedData['allow_Out_Tolerance']);

                                    $('#RFID_Number').trigger('change');
                                    $('#RFID_Serial_Number').trigger('change');
                                } else
                                    CommonAlert_Error("No any record(s) found");

                            } catch { }

                            ShowLoader(false);

                        }, 1000);

                    }
                },
                failure: function (response) {
                    CommonAlert_Error(null)
                },
                error: function (response) {
                    CommonAlert_Error(null)
                }
            });
        }

        function fnSubmitForm_Success(response, $id) {

            if (typeof $id != 'undefined' && $id != null && $id == 'AJAX') {
                

                if (response.statusCode === 1 && typeof response.data1 != 'undefined' && response.data1 != null && response.data1.trim() != '') {
                    // Set the value, creating a new option if necessary
                    if ($('#Transporter_Code_New').find("option[value='" + response.data1 + "']").length) {
                        $('#Transporter_Code_New').val(response.data1).trigger('change');
                    } else {
                        // Create a DOM Option and pre-select by default
                        var newOption = new Option(response.data2, response.data1, true, true);
                        // Append it to the select
                        $('#Transporter_Code_New').append(newOption).trigger('change');
                        $('#Transporter_Code_New').val(response.data1).trigger('change');
                    }

                }
            }
            else {
                $('input#input_Common_No').val('')
                $('input#input_Common_Date').val('')
                $('input#input_Common_Name').val('')
                $('input#input_Common_Code').val('')
                $('input#input_Common_Id').val('')
                $('input#input_Vendor_Id').val('')

                if (response.statusCode === 1) { fnClose_Modal(); }

                $('input#input_Common_No').trigger('change')
                $('input#input_Common_Date').trigger('change')
                $('input#input_Common_Name').trigger('change')
                $('input#input_Common_Code').trigger('change')
                $('input#Truck_No').trigger('change')
                $('input#input_Common_Id').trigger('change')
                $('input#input_Vendor_Id').trigger('change')
            }
        }

        $(document).on("change", 'input#Transporter_Changed', function (e) {
            

            $('input#Transporter_Code_New').val('');
            $('input#Transporter_Code_New').trigger('change');

            if (!$(".diveAddTransporter").hasClass("d-none") && !e.target.checked) { $(".diveAddTransporter").addClass("d-none"); }
            else if ($(".diveAddTransporter").hasClass("d-none") && e.target.checked) { $(".diveAddTransporter").removeClass("d-none"); }

        });

        function btnClick_AddTransporter() {
            

            $('#Transporter_Code_New').val('').trigger('change');

            ShowLoader(true);

            Swal.fire({
                icon: "warning",
                title: 'Create New Transporter',
                showDenyButton: false,
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Save',
                html: '<label class="col-form-label" style="align-content:start">Transporter Code <span style="color:red">*</span></label>' +
                    '<input type="text" class="swal2-input mb-3" name="Swal_Input_Transporter_Code" autocomplete="off"></br>' +
                    '<label class="col-form-label" style="align-content:start">Transporter Name <span style="color:red">*</span></label>' +
                    '<input type="text" class="swal2-input mb-1" name="Swal_Input_Transporter_Name" autocomplete="off">',
                preConfirm: () => {
                    
                    var enteredValue = $('input[name="Swal_Input_Transporter_Code"]').val();

                    if (typeof enteredValue == 'undefined' || enteredValue == null || enteredValue.trim() == "") {
                        Swal.showValidationMessage('Please enter Transporter Code');
                        return false;
                    }

                    enteredValue = $('input[name="Swal_Input_Transporter_Name"]').val();

                    if (typeof enteredValue == 'undefined' || enteredValue == null || enteredValue.trim() == "") {
                        Swal.showValidationMessage('Please enter Transporter Name');
                        return false;
                    }
                },
            }).then((result) => {

                if (result.isConfirmed === true) {
                    
                    let formData = new FormData();

                    formData.append("tptr_cd", $('input[name="Swal_Input_Transporter_Code"]').val());
                    formData.append("tptr_name", $('input[name="Swal_Input_Transporter_Name"]').val());
                    formData.append("IS_ENTRY_MANUAL", true);

                    ajaxPost('@Url.Action("Save_Transporter", "GateIn", new { area = "Export" })', formData);
                }

                ShowLoader(false);
            })

        }

    </script>
}